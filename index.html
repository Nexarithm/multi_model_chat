<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Model AI Chat</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Entry Page -->
    <div id="entry-page" class="chat-container">
        <h1>Multi-Model AI Chat</h1>
        <div id="loading-section" class="loading-section">
            <div class="loading-message">Loading available AI models...</div>
        </div>
        <div id="model-selection" class="model-selection" style="display: none;">
            <h2>Select Models to Query</h2>
            <div id="model-list" class="model-list"></div>
            <div class="selection-controls">
                <button id="select-all" class="control-button">Select All</button>
                <button id="deselect-all" class="control-button">Deselect All</button>
            </div>
            <div class="combiner-section">
                <h3>Combiner Model</h3>
                <select id="combiner-model" class="combiner-dropdown">
                    <option value="">Select a combiner model...</option>
                </select>
            </div>
            <div class="start-container">
                <button id="start-chat" class="start-button">Start Chat</button>
            </div>
        </div>
    </div>

    <!-- Chat Page -->
    <div id="chat-page" class="chat-container" style="display: none;">
        <h1>Multi-Model AI Chat</h1>
        <div id="metadata-box" class="metadata-box">
            <div class="metadata-section">
                <h4>Selected Models</h4>
                <div id="selected-models-list" class="models-list"></div>
            </div>
            <div class="metadata-section">
                <h4>Combiner Model</h4>
                <div id="combiner-model-display" class="combiner-display"></div>
            </div>
        </div>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="input-container">
            <input type="text" id="message-input" placeholder="Type your message here..." maxlength="5000">
            <button id="send-button">Send</button>
        </div>
    </div>

    <script>
        // Page elements
        const entryPage = document.getElementById('entry-page');
        const chatPage = document.getElementById('chat-page');
        const loadingSection = document.getElementById('loading-section');
        const modelSelection = document.getElementById('model-selection');
        const modelList = document.getElementById('model-list');
        const startChatButton = document.getElementById('start-chat');
        const selectAllButton = document.getElementById('select-all');
        const deselectAllButton = document.getElementById('deselect-all');
        const combinerModelSelect = document.getElementById('combiner-model');
        
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const selectedModelsList = document.getElementById('selected-models-list');
        const combinerModelDisplay = document.getElementById('combiner-model-display');

        let availableModels = [];
        let selectedModels = [];
        let combinerModel = null;

        function applyBasicFormatting(html) {
            // Bold text **text** or __text__
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
            
            // Italic text *text* or _text_
            html = html.replace(/(?<!\*)\*(?!\*)([^*]+)\*(?!\*)/g, '<em>$1</em>');
            html = html.replace(/(?<!_)_(?!_)([^_]+)_(?!_)/g, '<em>$1</em>');
            
            // Code inline `code`
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            return html;
        }

        function processBulletLists(html) {
            // Handle bullet points (lines starting with - or *)
            html = html.replace(/^[\s]*[-*]\s+(.+)$/gm, '<li>$1</li>');
            
            // Wrap consecutive list items in <ul>
            html = html.replace(/(<li>.*?<\/li>)(?:\s*<br>\s*<li>.*?<\/li>)*/g, function(match) {
                const listItems = match.replace(/<br>\s*/g, '');
                return '<ul>' + listItems + '</ul>';
            });
            
            return html;
        }

        function processNumberedLists(html) {
            // Handle numbered lists (lines starting with numbers)
            html = html.replace(/^[\s]*\d+\.\s+(.+)$/gm, '<li>$1</li>');
            
            // Wrap consecutive numbered list items in <ol>
            html = html.replace(/(<li>.*?<\/li>)(?:\s*<br>\s*(?=\d+\.\s))/g, function(match) {
                return match.replace(/<br>\s*/g, '');
            });
            
            return html;
        }

        function parseMarkdown(text) {
            // Handle newlines first
            let html = text.replace(/\n/g, '<br>');
            
            html = applyBasicFormatting(html);
            html = processBulletLists(html);
            html = processNumberedLists(html);
            
            return html;
        }

        function addMessage(message, isUser = false, isHtml = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            if (isUser) {
                // User messages - plain text
                messageDiv.textContent = message;
            } else {
                // Bot messages - parse markdown
                if (isHtml) {
                    messageDiv.innerHTML = message;
                } else {
                    messageDiv.innerHTML = parseMarkdown(message);
                }
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function createModelCheckbox(model) {
            const checkboxContainer = document.createElement('div');
            checkboxContainer.className = 'model-checkbox-container';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `model-${model.provider}-${model.model}`;
            checkbox.checked = true; // All selected by default
            checkbox.value = JSON.stringify(model);
            
            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = model.display_name;
            label.className = 'model-label';
            
            checkboxContainer.appendChild(checkbox);
            checkboxContainer.appendChild(label);
            
            return checkboxContainer;
        }

        function updateSelectedModels() {
            const checkboxes = modelList.querySelectorAll('input[type="checkbox"]');
            selectedModels = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => JSON.parse(cb.value));
            
            updateStartButton();
        }

        function updateCombinerModel() {
            const selectedValue = combinerModelSelect.value;
            combinerModel = selectedValue ? JSON.parse(selectedValue) : null;
            updateStartButton();
        }

        function updateStartButton() {
            startChatButton.disabled = selectedModels.length === 0 || !combinerModel;
        }

        function updateMetadataDisplay() {
            // Update selected models list
            selectedModelsList.innerHTML = '';
            selectedModels.forEach(model => {
                const modelTag = document.createElement('span');
                modelTag.className = 'model-tag';
                modelTag.textContent = model.display_name;
                selectedModelsList.appendChild(modelTag);
            });

            // Update combiner model display
            if (combinerModel) {
                combinerModelDisplay.textContent = combinerModel.display_name;
            }
        }

        function populateModelCheckboxes(models) {
            modelList.innerHTML = '';
            models.forEach(model => {
                const checkboxElement = createModelCheckbox(model);
                modelList.appendChild(checkboxElement);
            });
        }

        function populateCombinerDropdown(models) {
            combinerModelSelect.innerHTML = '<option value="">Select a combiner model...</option>';
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = JSON.stringify(model);
                option.textContent = model.display_name;
                combinerModelSelect.appendChild(option);
            });
        }

        function findDefaultCombiner(models) {
            // Look for Gemini models first
            let defaultCombiner = models.find(model => 
                model.display_name.toLowerCase().includes('gemini')
            );
            
            // If no Gemini, look for OpenAI models
            if (!defaultCombiner) {
                defaultCombiner = models.find(model => 
                    model.provider.toLowerCase().includes('openai') || 
                    model.display_name.toLowerCase().includes('openai') ||
                    model.display_name.toLowerCase().includes('gpt')
                );
            }
            
            // If no OpenAI, look for Claude models
            if (!defaultCombiner) {
                defaultCombiner = models.find(model => 
                    model.provider.toLowerCase().includes('claude') || 
                    model.display_name.toLowerCase().includes('claude')
                );
            }
            
            return defaultCombiner;
        }

        function setupModelEventListeners() {
            const checkboxes = modelList.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.addEventListener('change', updateSelectedModels);
            });
            combinerModelSelect.addEventListener('change', updateCombinerModel);
        }

        function showModelSelection() {
            loadingSection.style.display = 'none';
            modelSelection.style.display = 'block';
        }

        function showError(message) {
            loadingSection.innerHTML = `<div class="loading-message error">${message}</div>`;
        }

        async function loadModels() {
            try {
                const response = await fetch('/models');
                const data = await response.json();
                
                if (data.models && data.models.length > 0) {
                    availableModels = data.models;
                    const sortedModels = data.models.sort((a, b) => a.display_name.localeCompare(b.display_name));
                    
                    populateModelCheckboxes(sortedModels);
                    populateCombinerDropdown(sortedModels);
                    
                    const defaultCombiner = findDefaultCombiner(sortedModels);
                    if (defaultCombiner) {
                        combinerModelSelect.value = JSON.stringify(defaultCombiner);
                    }
                    
                    setupModelEventListeners();
                    updateSelectedModels();
                    updateCombinerModel();
                    showModelSelection();
                } else {
                    showError('No models available. Please try again later.');
                }
            } catch (error) {
                showError('Error loading models. Please try again later.');
            }
        }

        function prepareMessageForSending() {
            const message = messageInput.value.trim();
            if (!message) return null;

            addMessage(message, true);
            messageInput.value = '';
            sendButton.disabled = true;
            
            return message;
        }

        async function sendChatRequest(message) {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    message: message,
                    selected_models: selectedModels,
                    combiner_model: combinerModel
                })
            });
            return await response.json();
        }

        function handleChatResponse(data) {
            if (data.error) {
                addMessage('Error: ' + data.error, false);
            } else {
                addMessage(data.response, false);
            }
        }

        function resetMessageInput() {
            sendButton.disabled = false;
            messageInput.focus();
        }

        async function sendMessage() {
            const message = prepareMessageForSending();
            if (!message) return;

            try {
                const data = await sendChatRequest(message);
                handleChatResponse(data);
            } catch (error) {
                addMessage('Error: Could not connect to server', false);
            } finally {
                resetMessageInput();
            }
        }

        function handleStartChat() {
            if (selectedModels.length > 0 && combinerModel) {
                updateMetadataDisplay();
                entryPage.style.display = 'none';
                chatPage.style.display = 'block';
                messageInput.focus();
            }
        }

        function selectAllModels() {
            const checkboxes = modelList.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelectedModels();
        }

        function deselectAllModels() {
            const checkboxes = modelList.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectedModels();
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        }

        function setupGlobalEventListeners() {
            startChatButton.addEventListener('click', handleStartChat);
            selectAllButton.addEventListener('click', selectAllModels);
            deselectAllButton.addEventListener('click', deselectAllModels);
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', handleKeyPress);
        }

        // Initialize
        setupGlobalEventListeners();
        loadModels();
    </script>
</body>
</html>